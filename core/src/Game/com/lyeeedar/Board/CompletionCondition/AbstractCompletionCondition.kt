package com.lyeeedar.Board.CompletionCondition

import com.badlogic.gdx.scenes.scene2d.ui.Table
import com.lyeeedar.Board.Grid
import com.lyeeedar.Util.DataClass
import com.lyeeedar.Util.XmlData
import com.lyeeedar.Util.XmlDataClass

@DataClass(name = "CompletionCondition", global = true)
abstract class AbstractCompletionConditionData : XmlDataClass()
{
	abstract val classID: String

	override fun load(xmlData: XmlData)
	{
	/* Autogenerated method contents. Do not modify. */
	}

	companion object
	{
		fun loadPolymorphicClass(classID: String): AbstractCompletionConditionData
		{
		/* Autogenerated method contents. Do not modify. */
			return when (classID)
			{
				"Matches" -> CompletionConditionMatchesData()
				"Time" -> CompletionConditionTimeData()
				"Kill" -> CompletionConditionKillData()
				"Plate" -> CompletionConditionPlateData()
				"Sink" -> CompletionConditionSinkData()
				"None" -> CompletionConditionNoneData()
				"Turns" -> CompletionConditionTurnsData()
				"CustomOrb" -> CompletionConditionCustomOrbData()
				"Break" -> CompletionConditionBreakData()
				"Die" -> CompletionConditionDieData()
				else -> throw RuntimeException("Unknown classID '$classID' for AbstractCompletionConditionData!")
			}
		}
	}
}

abstract class AbstractCompletionCondition<T: AbstractCompletionConditionData>(val data: T)
{
	abstract fun attachHandlers(grid: Grid)
	abstract fun isCompleted(): Boolean
	abstract fun createTable(grid: Grid): Table
	abstract fun getDescription(grid: Grid): Table

	companion object
	{
		fun load(xml: XmlData): AbstractCompletionCondition<*>
		{
			val data = AbstractCompletionConditionData.loadPolymorphicClass(xml.get("classID"))
			data.load(xml)

			val obj = get(data)
			return obj
		}

		private fun get(data: AbstractCompletionConditionData): AbstractCompletionCondition<*>
		{
			val instance = when(data.classID)
			{
				"NONE" -> CompletionConditionNone(data as CompletionConditionNoneData)

			// Defeat
				"DIE" -> CompletionConditionDie(data as CompletionConditionDieData)
				"TURNS" -> CompletionConditionTurns(data as CompletionConditionTurnsData)
				"TIME" -> CompletionConditionTime(data as CompletionConditionTimeData)

			// Victory
				"KILL" -> CompletionConditionKill(data as CompletionConditionKillData)
				"MATCHES" -> CompletionConditionMatches(data as CompletionConditionMatchesData)
				"SINK" -> CompletionConditionSink(data as CompletionConditionSinkData)
				"PLATE" -> CompletionConditionPlate(data as CompletionConditionPlateData)
				"CUSTOMORB" -> CompletionConditionCustomOrb(data as CompletionConditionCustomOrbData)
				"BREAK" -> CompletionConditionBreak(data as CompletionConditionBreakData)

			// ARGH everything broke
				else -> throw RuntimeException("Invalid completion condition type: ${data.classID}")
			}

			return instance
		}
	}
}